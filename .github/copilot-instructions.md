# SchoolManagementAPI - AI Coding Agent Instructions

## Architecture Overview

This is an ASP.NET Core 7.0 Web API using a **3-layer clean architecture**:
- **SchoolManagementAPI** (Web/API layer) - Controllers, Program.cs
- **Libraries/Services** - Business logic layer
- **Libraries/Repository** - Data access with Entity Framework Core
- **Libraries/Models** - Shared DTOs and domain models across all layers

**Critical**: All layers are separate projects. Dependencies flow inward: API → Services → Repository → Models.

## Dependency Injection Pattern

All service registration uses **extension methods** in `DependencyInjection.cs`:

```csharp
// Services/DependencyInjection.cs calls Repository/DependencyInjection.cs
service.RepositoryDependencyInjection(config);
service.AddScoped<IInstitutionDetailsService, InstitutionDetailsService>();
```

**When adding new features**:
1. Create interface + implementation in respective folder (e.g., `Services/NewFeatureServices/`)
2. Register in the appropriate `DependencyInjection.cs` using `AddScoped<I, Implementation>()`
3. All services use interface-based injection for testability

## Database & Entity Framework

- **DbContext**: `Repository/Entity/SchoolManagementContext.cs` (database-first approach)
- **Connection String**: Stored in `appsettings.json` under `ConnectionStrings:DefaultConnection`
- **SQL Server**: Target database is `SchoolManagement` with Windows/SQL authentication

### Regenerating Entity Models from Database

**Use the provided batch file** when database schema changes:
```powershell
.\Libraries\Repository\EntityFrameworkDBSync.bat
```

This runs: `dotnet ef dbcontext scaffold` with `--force` flag to overwrite entities in `Repository/Entity/`.

**Important**: The DbContext contains a hardcoded connection string (see `#warning` in code). This is auto-generated by EF scaffolding—ignore the warning, actual runtime connection comes from `appsettings.json`.

## Response Pattern Convention

All API responses use the generic wrapper: `CommonResponse<T>` from `Models/CommonModels/`:

```csharp
var response = new CommonResponse<YourResponseType>();
response.Status = Status.Success; // or Status.Failed
response.Message = "Operation details";
response.Data = yourData;
return response;
```

**Status enum values**: `Success = 200`, `Failed = 300` (not HTTP status codes—these are application-level statuses).

## Security & Authentication

### Password Encryption
Uses AES encryption with a hardcoded key in `CommonService.Encrypt()`:
- **Encryption Key**: `"My@Vision$To*Make!My#MoM^Proude"` (fixed salt array in code)
- Encrypt passwords before database comparison: `request.Password = await _commonService.Encrypt(request.Password);`

### JWT Token Generation
JWT claims include: UserName, SysId, IpAddress, InstitutionCode, LoginType, Guid, IsHOD, IsPrincipal
- Token signing key: `JwtKey.AuthKey` (static class in `Models/ConfigurationModels/`)
- Configuration: Read from `JwtConfig` and `AppKeyConfig` via `IOptionsSnapshot<>`
- Token expiry: Default 15 minutes (`_appKeyConfig.TokenExpiry`)

**IP Address Capture**: Controllers extract client IP via `HttpContext.Connection.RemoteIpAddress` and pass to services (see `UserController.LoginAsync`).

## Controller Conventions

- Route pattern: `[Route("[controller]")]` uses controller name (e.g., `/InstitutionDetails`)
- Action-specific routes: Use attributes like `[HttpPost("SMS/login")]` for custom paths
- All controllers inject services via constructor, use `async Task<IActionResult>` for actions
- Return `Ok(response)` where `response` is always `CommonResponse<T>`

## Namespace Organization

Strict namespace-to-folder alignment:
- `Repository.InstitutionDetails` → `Libraries/Repository/InstitutionDetailsRepository/`
- `Services.UserServices` → `Libraries/Services/UserServices/`
- `Models.ConfigurationModels` → `Libraries/Models/ConfigurationModels/`

**Naming quirk**: Repository interfaces use `Repo` suffix (e.g., `IInstitutionDetailsRepo`), but folders say `Repository`.

## Running the Application

- **Launch URL**: Swagger UI at `/swagger` (configured in `launchSettings.json`)
- **Development ports**: HTTPS 7097, HTTP 5274
- **CORS**: Fully open (AllowAnyHeader/Method/Origin) in `Program.cs`—configured for development

## Common Patterns to Follow

### Adding a New Feature (e.g., "Student")

1. **Models**: Create `Libraries/Models/StudentModels/StudentRequest.cs` + `StudentResponse.cs`
2. **Repository**: 
   - Interface: `Libraries/Repository/StudentRepository/IStudentRepo.cs`
   - Implementation: `StudentRepo.cs` with DbContext queries
   - Register in `Repository/DependencyInjection.cs`
3. **Services**:
   - Interface: `Libraries/Services/StudentServices/IStudentService.cs`
   - Implementation: `StudentService.cs` wrapping responses in `CommonResponse<T>`
   - Register in `Services/DependencyInjection.cs`
4. **Controller**: `SchoolManagementAPI/Controllers/StudentController.cs`

### Data Access Pattern
Repository methods return **DTOs directly** (e.g., `InstitutionDetailsResponse`), not entity objects:
```csharp
// LINQ projects to response DTOs, not entities
select new InstitutionDetailsResponse { InstitutionName = x.InstitutionName, ... }
```

Services wrap repository results in `CommonResponse<T>` and handle error status/messages.

## Technology Stack

- .NET 7.0
- Entity Framework Core 7.0.20
- SQL Server (Microsoft.EntityFrameworkCore.SqlServer)
- Swashbuckle (Swagger/OpenAPI)
- JWT (System.IdentityModel.Tokens.Jwt)

## Files to Reference

- Dependency wiring: `*/DependencyInjection.cs` in each library
- DB sync script: `Libraries/Repository/EntityFrameworkDBSync.bat`
- Scaffold command reference: `Model Update CMD.txt`
- JWT key storage: `Models/ConfigurationModels/JwtKey.cs`
